<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Haky Im based on cziscience page">
<meta name="dcterms.date" content="2025-05-13">

<title>scgpt quickstart - qmd version – GENE 46100</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-dcc7d9e706e4adfbab8e3d6c7c60bab2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">GENE 46100</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#quick-start-scgpt" id="toc-quick-start-scgpt" class="nav-link active" data-scroll-target="#quick-start-scgpt">Quick Start: scGPT</a>
  <ul class="collapse">
  <li><a href="#learning-goals" id="toc-learning-goals" class="nav-link" data-scroll-target="#learning-goals">Learning Goals</a></li>
  <li><a href="#pre-requisites-and-requirements" id="toc-pre-requisites-and-requirements" class="nav-link" data-scroll-target="#pre-requisites-and-requirements">Pre-requisites and Requirements</a></li>
  <li><a href="#anndata-structure" id="toc-anndata-structure" class="nav-link" data-scroll-target="#anndata-structure">AnnData Structure</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#download-and-prepare-data" id="toc-download-and-prepare-data" class="nav-link" data-scroll-target="#download-and-prepare-data">Download and Prepare Data</a></li>
  <li><a href="#model-inference-and-embedding-generation" id="toc-model-inference-and-embedding-generation" class="nav-link" data-scroll-target="#model-inference-and-embedding-generation">Model Inference and Embedding Generation</a></li>
  <li><a href="#dimensionality-reduction-and-visualization" id="toc-dimensionality-reduction-and-visualization" class="nav-link" data-scroll-target="#dimensionality-reduction-and-visualization">Dimensionality Reduction and Visualization</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization">Visualization</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">scgpt quickstart - qmd version</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">notebook</div>
    <div class="quarto-category">gene46100</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Haky Im based on cziscience page </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 13, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This tutorial will guide you through using scGPT, a foundation model for single-cell data analysis. We’ll learn how to process single-cell data and generate meaningful embeddings that can be used for various downstream analyses.</p>
<p>Downloaded from https://virtualcellmodels.cziscience.com/quickstart/scgpt-quickstart</p>
<section id="quick-start-scgpt" class="level2">
<h2 class="anchored" data-anchor-id="quick-start-scgpt">Quick Start: scGPT</h2>
<p>This quick start will guide you through using the scGPT model, trained on 33 million cells (including data from the CZ CELLxGENE Census), to generate embeddings for single-cell transcriptomic data analysis.</p>
<section id="learning-goals" class="level3">
<h3 class="anchored" data-anchor-id="learning-goals">Learning Goals</h3>
<p>By the end of this tutorial, you will understand how to:</p>
<ul>
<li>Access and prepare the scGPT model for use</li>
<li>Generate embeddings to analyze and compare your dataset against the CZ CELLxGENE Census</li>
<li>Visualize the results using a UMAP, colored by cell type</li>
</ul>
</section>
<section id="pre-requisites-and-requirements" class="level3">
<h3 class="anchored" data-anchor-id="pre-requisites-and-requirements">Pre-requisites and Requirements</h3>
<blockquote class="blockquote">
<p><strong>Important</strong>: Before starting, make sure you have: 1. Python 3.9 installed 2. Basic understanding of single-cell data analysis 3. At least 32GB of RAM (tested on M3 MacBook)</p>
</blockquote>
<p>Before starting, ensure you are familiar with:</p>
<ul>
<li>Python and AnnData</li>
<li>Single-cell data analysis (see this tutorial for a primer on the subject)<br>
You can run this tutorial locally (tested on an M3 MacBook with 32 GiB memory) or in Google Colab using a T4 instance. Environment setup will be covered in a later section.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../../post/images/anndata_schema.svg" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>AnnData schema</figcaption>
</figure>
</div>
</section>
<section id="anndata-structure" class="level3">
<h3 class="anchored" data-anchor-id="anndata-structure">AnnData Structure</h3>
<blockquote class="blockquote">
<p><strong>Key Concept</strong>: AnnData is the fundamental data structure for single-cell analysis in Python. Understanding its structure is necessary for working with scGPT and other tools.</p>
</blockquote>
<p>The AnnData object is a Python-based data structure used by scanpy, scGPT, and other single-cell analysis tools. Here are its key components:</p>
<section id="main-attributes" class="level4">
<h4 class="anchored" data-anchor-id="main-attributes">Main Attributes</h4>
<ul>
<li><code>.X</code>: Main data matrix (cells × genes)</li>
<li><code>.obs</code>: Cell annotations (pandas dataframe with metadata for each cell)</li>
<li><code>.var</code>: Gene annotations (pandas dataframe with metadata for each gene)</li>
</ul>
</section>
<section id="embedding-storage" class="level4">
<h4 class="anchored" data-anchor-id="embedding-storage">Embedding Storage</h4>
<ul>
<li><code>.obsm</code>: Cell embeddings (e.g., PCA, UMAP coordinates)</li>
<li><code>.varm</code>: Gene embeddings (e.g., gene loadings)</li>
</ul>
</section>
</section>
<section id="overview" class="level3">
<h3 class="anchored" data-anchor-id="overview">Overview</h3>
<p>This notebook provides a step-by-step guide to:</p>
<ul>
<li>Setting up your environment</li>
<li>Downloading the necessary model checkpoints and h5ad dataset</li>
<li>Performing model inference to create embeddings</li>
<li>Visualizing the results with UMAP</li>
</ul>
</section>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<blockquote class="blockquote">
<p><strong>Environment Setup Note</strong>: 1. We’ll create a new conda environment for this tutorial 2. We need specific versions of PyTorch and other dependencies 3. The setup process might take a few minutes</p>
</blockquote>
<p>Let’s start by setting up dependencies. The released version of scGPT requires PyTorch 2.1.2, so we will remove the existing PyTorch installation and replace it with the required one. If you want to run this on another environment, this step might not be necessary.</p>
<p><strong>Note</strong>: I encountered an error with torch version. I installed torch 2.3.0 and torchvision 0.16.2, and then reinstalled torch 2.1.2.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="in"># Create and activate a new conda environment</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="in">conda create -n scgpt python=3.9</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="in">conda activate scgpt</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="setup-dependencies" class="cell" data-fold="true" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment setup and package installation</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>first_time <span class="op">=</span> <span class="va">False</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> first_time:</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First uninstall the conflicting packages</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip uninstall <span class="op">-</span>y <span class="op">-</span>q torch torchvision</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip uninstall <span class="op">-</span>y numpy pandas scipy scikit<span class="op">-</span>learn anndata cell<span class="op">-</span>gears datasets dcor</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#%pip install -q torchvision==0.16.2 torch==2.1.2</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install <span class="op">-</span>q torch<span class="op">==</span><span class="fl">2.3.0</span> torchvision<span class="op">==</span><span class="fl">0.16.2</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install <span class="op">-</span>q scgpt scanpy gdown</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Then install them in the correct order with specific versions</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install numpy<span class="op">==</span><span class="fl">1.23.5</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install pandas<span class="op">==</span><span class="fl">1.5.3</span>  <span class="co"># This version is compatible with anndata 0.10.9</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install scipy<span class="op">==</span><span class="fl">1.10.1</span>  <span class="co"># This version is &gt;1.8 as required by anndata</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install scikit<span class="op">-</span>learn<span class="op">==</span><span class="fl">1.2.2</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install anndata<span class="op">==</span><span class="fl">0.10.9</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install cell<span class="op">-</span>gears<span class="op">==</span><span class="fl">0.0.2</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install dcor<span class="op">==</span><span class="fl">0.6</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install datasets<span class="op">==</span><span class="fl">2.3.0</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First uninstall both packages</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip uninstall <span class="op">-</span>y torch torchtext</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Then install compatible versions</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install torch<span class="op">==</span><span class="fl">2.1.2</span> torchtext<span class="op">==</span><span class="fl">0.16.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Package Installation Note</strong>: - We install specific versions of packages to ensure compatibility - The order of installation matters - Some packages are uninstalled first to avoid conflicts</p>
</blockquote>
<div id="import-libraries" class="cell" data-fold="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set MPS fallback for unimplemented operations</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'PYTORCH_ENABLE_MPS_FALLBACK'</span>] <span class="op">=</span> <span class="st">'1'</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Monkey-patch os.sched_getaffinity for macOS</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(os, <span class="st">'sched_getaffinity'</span>):</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sched_getaffinity(pid):</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">set</span>(<span class="bu">range</span>(multiprocessing.cpu_count()))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    os.sched_getaffinity <span class="op">=</span> sched_getaffinity</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scgpt <span class="im">as</span> scg</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scanpy <span class="im">as</span> sc</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for MPS availability</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> (</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    torch.device(<span class="st">"mps"</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.backends.mps.is_available()</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> torch.device(<span class="st">"cpu"</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using device: </span><span class="sc">{</span>device<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Note: Some operations may fall back to CPU due to MPS limitations"</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Library Import Note</strong>: - We import all necessary libraries for data processing and model inference - Special handling for macOS MPS (Metal Performance Shaders) - Warning suppression for cleaner output</p>
</blockquote>
<div id="setup-directories" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the base working directory</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>WORKDIR <span class="op">=</span> <span class="st">"/Users/haekyungim/Library/CloudStorage/Box-Box/LargeFiles/imlab-data/data-Github/web-data/web-GENE-46100/scgpt"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Path objects for better path handling</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>WORKDIR <span class="op">=</span> Path(WORKDIR)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>DATA_DIR <span class="op">=</span> WORKDIR <span class="op">/</span> <span class="st">"data"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>MODEL_DIR <span class="op">=</span> WORKDIR <span class="op">/</span> <span class="st">"model"</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Directory Setup Note</strong>: - We create a structured directory for data and model files - Using Path objects for cross-platform compatibility</p>
</blockquote>
</section>
<section id="download-and-prepare-data" class="level3">
<h3 class="anchored" data-anchor-id="download-and-prepare-data">Download and Prepare Data</h3>
<blockquote class="blockquote">
<p><strong>Data Download Note</strong>: - We’ll download both the model and a sample dataset - The dataset will be processed to reduce memory usage - We’ll use highly variable genes for better analysis</p>
</blockquote>
<div id="download-model" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">"ignore"</span>, <span class="pp">ResourceWarning</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">ImportWarning</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use gdown with the recursive flag to download the folder</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>folder_id <span class="op">=</span> <span class="st">'1oWh_-ZRdhtoGQ2Fw24HP41FgLoomVo-y'</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if model files already exist</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> (MODEL_DIR <span class="op">/</span> <span class="st">"args.json"</span>).exists():</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Downloading model checkpoint..."</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>gdown <span class="op">--</span>folder {folder_id} <span class="op">-</span>O {MODEL_DIR}</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Model files already exist in"</span>, MODEL_DIR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Model Download Note</strong>: - The model is downloaded from Google Drive - We check if files exist to avoid re-downloading - The model is about 200MB in size</p>
</blockquote>
<div id="download-data" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> <span class="st">"https://datasets.cellxgene.cziscience.com/f50deffa-43ae-4f12-85ed-33e45040a1fa.h5ad"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>source_path <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">"source.h5ad"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if file exists before downloading</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> source_path.exists():</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Downloading dataset to </span><span class="sc">{</span>source_path<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    urllib.request.urlretrieve(uri, filename<span class="op">=</span><span class="bu">str</span>(source_path))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Dataset already exists at </span><span class="sc">{</span>source_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the data</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> sc.read_h5ad(source_path)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>batch_key <span class="op">=</span> <span class="st">"sample"</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>N_HVG <span class="op">=</span> <span class="dv">3000</span>  <span class="co"># Number of highly variable genes to select</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Select highly variable genes to reduce memory usage</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>sc.pp.highly_variable_genes(adata, n_top_genes<span class="op">=</span>N_HVG, flavor<span class="op">=</span><span class="st">'seurat_v3'</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>adata_hvg <span class="op">=</span> adata[:, adata.var[<span class="st">'highly_variable'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Data Processing Note</strong>: - We download a sample dataset from CZ CELLxGENE - The dataset is reduced to 3000 highly variable genes - This reduction helps with memory usage and computation speed</p>
</blockquote>
</section>
<section id="model-inference-and-embedding-generation" class="level3">
<h3 class="anchored" data-anchor-id="model-inference-and-embedding-generation">Model Inference and Embedding Generation</h3>
<blockquote class="blockquote">
<p><strong>Key Concept</strong>: In this section, we’ll: 1. Set up the model for inference 2. Generate cell embeddings using scGPT 3. Process these embeddings for downstream analysis</p>
<p><strong>Note</strong>: The embedding generation process might take several minutes depending on your hardware.</p>
</blockquote>
<div id="setup-embedding" class="cell" data-fold="true" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Monkey patch get_batch_cell_embeddings to force single processor</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> types</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scgpt.tasks.cell_emb <span class="im">import</span> get_batch_cell_embeddings <span class="im">as</span> original_get_batch_cell_embeddings</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader, SequentialSampler</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scgpt.data_collator <span class="im">import</span> DataCollator</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Dataset class at module level</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CellEmbeddingDataset(Dataset):</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Custom dataset class for cell embedding generation.</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Processes single-cell data into a format suitable for the scGPT model.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, count_matrix, gene_ids, batch_ids<span class="op">=</span><span class="va">None</span>, vocab<span class="op">=</span><span class="va">None</span>, model_configs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.count_matrix <span class="op">=</span> count_matrix</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gene_ids <span class="op">=</span> gene_ids</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_ids <span class="op">=</span> batch_ids</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vocab <span class="op">=</span> vocab</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_configs <span class="op">=</span> model_configs</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.count_matrix)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process a single cell's data</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> <span class="va">self</span>.count_matrix[idx]</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        nonzero_idx <span class="op">=</span> np.nonzero(row)[<span class="dv">0</span>]</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> row[nonzero_idx]</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        genes <span class="op">=</span> <span class="va">self</span>.gene_ids[nonzero_idx]</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># append &lt;cls&gt; token at the beginning</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        genes <span class="op">=</span> np.insert(genes, <span class="dv">0</span>, <span class="va">self</span>.vocab[<span class="st">"&lt;cls&gt;"</span>])</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> np.insert(values, <span class="dv">0</span>, <span class="va">self</span>.model_configs[<span class="st">"pad_value"</span>])</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        genes <span class="op">=</span> torch.from_numpy(genes).<span class="bu">long</span>()</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> torch.from_numpy(values).<span class="bu">float</span>()</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> {</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"id"</span>: idx,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"genes"</span>: genes,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">"expressions"</span>: values,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.batch_ids <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>            output[<span class="st">"batch_labels"</span>] <span class="op">=</span> <span class="va">self</span>.batch_ids[idx]</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> patched_get_batch_cell_embeddings(</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    adata,</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    cell_embedding_mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">"cls"</span>,</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    vocab<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    max_length<span class="op">=</span><span class="dv">1200</span>,</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    model_configs<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    gene_ids<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    use_batch_labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a><span class="co">    Patched version of get_batch_cell_embeddings that uses the module-level Dataset class</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a><span class="co">    and forces num_workers=0 for better compatibility.</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert data to appropriate format</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    count_matrix <span class="op">=</span> adata.X</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    count_matrix <span class="op">=</span> (</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>        count_matrix <span class="cf">if</span> <span class="bu">isinstance</span>(count_matrix, np.ndarray) <span class="cf">else</span> count_matrix.toarray()</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get gene vocabulary ids</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gene_ids <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        gene_ids <span class="op">=</span> np.array(adata.var[<span class="st">"id_in_vocab"</span>])</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> np.<span class="bu">all</span>(gene_ids <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_batch_labels:</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        batch_ids <span class="op">=</span> np.array(adata.obs[<span class="st">"batch_id"</span>].tolist())</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cell_embedding_mode <span class="op">==</span> <span class="st">"cls"</span>:</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up dataset and data loader</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>        dataset <span class="op">=</span> CellEmbeddingDataset(</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>            count_matrix, </span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>            gene_ids, </span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>            batch_ids <span class="cf">if</span> use_batch_labels <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>            vocab<span class="op">=</span>vocab,</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>            model_configs<span class="op">=</span>model_configs</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>        collator <span class="op">=</span> DataCollator(</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>            do_padding<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>            pad_token_id<span class="op">=</span>vocab[model_configs[<span class="st">"pad_token"</span>]],</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>            pad_value<span class="op">=</span>model_configs[<span class="st">"pad_value"</span>],</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>            do_mlm<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>            do_binning<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>            max_length<span class="op">=</span>max_length,</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>            sampling<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>            keep_first_n_tokens<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>        data_loader <span class="op">=</span> DataLoader(</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>            dataset,</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size,</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>            sampler<span class="op">=</span>SequentialSampler(dataset),</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>            collate_fn<span class="op">=</span>collator,</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>            drop_last<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>            num_workers<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Force single worker for compatibility</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>            pin_memory<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate embeddings</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>        cell_embeddings <span class="op">=</span> np.zeros(</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>            (<span class="bu">len</span>(dataset), model_configs[<span class="st">"embsize"</span>]), dtype<span class="op">=</span>np.float32</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> data_dict <span class="kw">in</span> tqdm(data_loader, desc<span class="op">=</span><span class="st">"Embedding cells"</span>):</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Process each batch of cells</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>                input_gene_ids <span class="op">=</span> data_dict[<span class="st">"gene"</span>].to(device)</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>                src_key_padding_mask <span class="op">=</span> input_gene_ids.eq(</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>                    vocab[model_configs[<span class="st">"pad_token"</span>]]</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>                embeddings <span class="op">=</span> model._encode(</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>                    input_gene_ids,</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>                    data_dict[<span class="st">"expr"</span>].to(device),</span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>                    src_key_padding_mask<span class="op">=</span>src_key_padding_mask,</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>                    batch_labels<span class="op">=</span>data_dict[<span class="st">"batch_labels"</span>].to(device)</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> use_batch_labels</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Extract CLS token embeddings and normalize</span></span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>                embeddings <span class="op">=</span> embeddings[:, <span class="dv">0</span>, :]  <span class="co"># get the &lt;cls&gt; position embedding</span></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>                embeddings <span class="op">=</span> embeddings.cpu().numpy()</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>                cell_embeddings[count : count <span class="op">+</span> <span class="bu">len</span>(embeddings)] <span class="op">=</span> embeddings</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>                count <span class="op">+=</span> <span class="bu">len</span>(embeddings)</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>        cell_embeddings <span class="op">=</span> cell_embeddings <span class="op">/</span> np.linalg.norm(</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>            cell_embeddings, axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown cell embedding mode: </span><span class="sc">{</span>cell_embedding_mode<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cell_embeddings</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace the original function with our patched version</span></span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scgpt.tasks.cell_emb</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>scgpt.tasks.cell_emb.get_batch_cell_embeddings <span class="op">=</span> patched_get_batch_cell_embeddings</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'PYTHONWARNINGS'</span>] <span class="op">=</span> <span class="st">'ignore'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Technical Note</strong>: The code above: - Creates a custom dataset class for processing single-cell data - Implements a patched version of the embedding function for better compatibility - Handles data batching and normalization - Uses the CLS token for cell representation</p>
</blockquote>
<div id="generate-embeddings" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model_dir <span class="op">=</span> MODEL_DIR</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>gene_col <span class="op">=</span> <span class="st">"feature_name"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>cell_type_key <span class="op">=</span> <span class="st">"cell_type"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>embedding_file <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">"ref_embed_adata.h5ad"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> embedding_file.exists():</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Loading existing embeddings from </span><span class="sc">{</span>embedding_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    ref_embed_adata <span class="op">=</span> sc.read_h5ad(<span class="bu">str</span>(embedding_file))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Computing new embeddings..."</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    ref_embed_adata <span class="op">=</span> scg.tasks.embed_data(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        adata_hvg,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        model_dir,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        gene_col<span class="op">=</span>gene_col,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        obs_to_save<span class="op">=</span>cell_type_key,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        return_new_adata<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        device<span class="op">=</span>device,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saving embeddings to </span><span class="sc">{</span>embedding_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    ref_embed_adata.write(<span class="bu">str</span>(embedding_file))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Embedding Generation Note</strong>: - We first check if embeddings already exist to avoid recomputing - The embedding process generates a 512-dimensional representation for each cell - Results are saved for future use</p>
</blockquote>
<div id="check-embeddings" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the shape of our embeddings</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ref_embed_adata.X.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Shape Explanation</strong>: - The output shows (number of cells × 512) - 512 is the embedding dimension of scGPT - Each cell is represented by a 512-dimensional vector</p>
</blockquote>
</section>
<section id="dimensionality-reduction-and-visualization" class="level3">
<h3 class="anchored" data-anchor-id="dimensionality-reduction-and-visualization">Dimensionality Reduction and Visualization</h3>
<blockquote class="blockquote">
<p><strong>Key Concept</strong>: In this section, we’ll: 1. Compute cell-cell similarities using the embeddings 2. Generate a UMAP visualization 3. Compare different cell type annotations</p>
<p><strong>Note</strong>: UMAP helps us visualize high-dimensional data in 2D while preserving important relationships.</p>
</blockquote>
<div id="compute-neighbors" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute cell-cell similarities</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(ref_embed_adata, use_rep<span class="op">=</span><span class="st">"X"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate UMAP coordinates</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(ref_embed_adata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Neighborhood Graph Note</strong>: - We compute a neighborhood graph based on the embeddings - This graph is used to generate the UMAP visualization</p>
</blockquote>
<div id="transfer-embeddings" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transfer embeddings and UMAP to original adata object</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">"X_scgpt"</span>] <span class="op">=</span> ref_embed_adata.X</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">"X_umap"</span>] <span class="op">=</span> ref_embed_adata.obsm[<span class="st">"X_umap"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Data Transfer Note</strong>: - We transfer the embeddings and UMAP coordinates to our original dataset - This allows us to use the original annotations with our new embeddings - The embeddings are stored in <code>.obsm</code> for easy access</p>
</blockquote>
<div id="prepare-gene-names" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the current index ('ensembl_id') as a new column</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'ensembl_id'</span>] <span class="op">=</span> adata.var.index</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the new index to the 'feature_name' column</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>adata.var.set_index(<span class="st">'feature_name'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a copy of the gene symbols back to the var dataframe</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'gene_symbol'</span>] <span class="op">=</span> adata.var.index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Gene Name Processing Note</strong>: - We reorganize the gene annotations for easier access - This allows us to use gene symbols in visualizations - Both Ensembl IDs and gene symbols are preserved</p>
</blockquote>
</section>
<section id="visualization" class="level3">
<h3 class="anchored" data-anchor-id="visualization">Visualization</h3>
<blockquote class="blockquote">
<p><strong>Key Concept</strong>: In this section, we’ll: 1. Visualize the UMAP colored by different cell type annotations 2. Examine marker gene expression 3. Compare different annotation schemes</p>
</blockquote>
<div id="plot-umap-celltypes" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    sc.pl.umap(adata, color<span class="op">=</span>[<span class="st">"cell_type"</span>, <span class="st">"annotation_res0.34_new2"</span>], wspace <span class="op">=</span> <span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>UMAP Visualization Note</strong>: - The plot shows cells colored by two different annotation schemes - This helps us compare different cell type classifications - The spatial organization reflects cell type relationships</p>
</blockquote>
<div id="plot-umap-markers" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize marker genes for different cell types</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>           color<span class="op">=</span>[<span class="st">'cell_type'</span>, <span class="st">'MKI67'</span>, <span class="st">'LYZ'</span>, <span class="st">'RBP2'</span>, <span class="st">'MUC2'</span>, <span class="st">'CHGA'</span>, <span class="st">'TAGLN'</span>, <span class="st">'ELAVL3'</span>], </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>           frameon<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>           use_raw<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>           legend_fontsize<span class="op">=</span><span class="st">"xx-small"</span>, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>           legend_loc<span class="op">=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Marker Gene Note</strong>: - We visualize expression of key marker genes - These genes help identify different cell types: - MKI67: Proliferating cells - LYZ: Myeloid cells - RBP2: Enterocytes - MUC2: Goblet cells - CHGA: Enteroendocrine cells - TAGLN: Smooth muscle cells - ELAVL3: Neurons</p>
</blockquote>
</section>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references">References</h3>
<blockquote class="blockquote">
<p><strong>Key Papers</strong>: 1. scGPT paper: Foundation model for single-cell multi-omics 2. Dataset paper: iPSC-derived small intestine-on-chip 3. CZ CELLxGENE platform paper</p>
</blockquote>
<p>Please refer to the following papers for more information:</p>
<ol type="1">
<li><p><strong>scGPT: Toward building a foundation model for single-cell multi-omics using generative AI</strong> Cui, H., Wang, C., Maan, H. et al.&nbsp;Nature Methods 21, 1470–1480 (2024) https://doi.org/10.1038/s41592-024-02201-0</p></li>
<li><p><strong>The dataset used in this tutorial</strong> Moerkens, R., et al.&nbsp;Cell Reports, 43(7) (2024) https://doi.org/10.1016/j.celrep.2024.114247</p></li>
<li><p><strong>CZ CELLxGENE Discover and Census</strong> CZI Single-Cell Biology, et al.&nbsp;bioRxiv 2023.10.30 doi: https://doi.org/10.1101/2023.10.30.563174</p></li>
</ol>


<!-- -->

</section>
</section>

<p>© <a href="https://hakyimlab.org">HakyImLab and Listed Authors</a> - <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0 License</a></p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb15" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> scgpt quickstart - qmd version</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="an">freeze:</span><span class="co"> true</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="an">eval:</span><span class="co"> false</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Haky Im based on cziscience page</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-05-13</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> </span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - notebook</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - gene46100</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>This tutorial will guide you through using scGPT, a foundation model for single-cell data analysis. We'll learn how to process single-cell data and generate meaningful embeddings that can be used for various downstream analyses.</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>Downloaded from </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>https://virtualcellmodels.cziscience.com/quickstart/scgpt-quickstart</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quick Start: scGPT</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>This quick start will guide you through using the scGPT model, trained on 33 million cells (including data from the CZ CELLxGENE Census), to generate embeddings for single-cell transcriptomic data analysis.</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="fu">### Learning Goals</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>By the end of this tutorial, you will understand how to:</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Access and prepare the scGPT model for use</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Generate embeddings to analyze and compare your dataset against the CZ CELLxGENE Census</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Visualize the results using a UMAP, colored by cell type</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pre-requisites and Requirements</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Important**: Before starting, make sure you have:</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 1. Python 3.9 installed</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 2. Basic understanding of single-cell data analysis</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 3. At least 32GB of RAM (tested on M3 MacBook)</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>Before starting, ensure you are familiar with:</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Python and AnnData</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Single-cell data analysis (see this tutorial for a primer on the subject)  </span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  You can run this tutorial locally (tested on an M3 MacBook with 32 GiB memory) or in Google Colab using a T4 instance. Environment setup will be covered in a later section.</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="al">![AnnData schema](/post/images/anndata_schema.svg)</span>{width=50%}</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="fu">### AnnData Structure</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Key Concept**: AnnData is the fundamental data structure for single-cell analysis in Python. Understanding its structure is necessary for working with scGPT and other tools.</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>The AnnData object is a Python-based data structure used by scanpy, scGPT, and other single-cell analysis tools. Here are its key components:</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Main Attributes</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`.X`</span>: Main data matrix (cells × genes)</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`.obs`</span>: Cell annotations (pandas dataframe with metadata for each cell)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`.var`</span>: Gene annotations (pandas dataframe with metadata for each gene)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Embedding Storage</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`.obsm`</span>: Cell embeddings (e.g., PCA, UMAP coordinates)</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`.varm`</span>: Gene embeddings (e.g., gene loadings)</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a><span class="fu">### Overview</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>This notebook provides a step-by-step guide to:</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Setting up your environment</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Downloading the necessary model checkpoints and h5ad dataset</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Performing model inference to create embeddings</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Visualizing the results with UMAP</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a><span class="fu">### Setup</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Environment Setup Note**: </span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 1. We'll create a new conda environment for this tutorial</span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 2. We need specific versions of PyTorch and other dependencies</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 3. The setup process might take a few minutes</span></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>Let's start by setting up dependencies. The released version of scGPT requires PyTorch 2.1.2, so we will remove the existing PyTorch installation and replace it with the required one. If you want to run this on another environment, this step might not be necessary.</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>**Note**: I encountered an error with torch version. I installed torch 2.3.0 and torchvision 0.16.2, and then reinstalled torch 2.1.2.</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash}</span></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a><span class="in"># Create and activate a new conda environment</span></span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a><span class="in">conda create -n scgpt python=3.9</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a><span class="in">conda activate scgpt</span></span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-dependencies</span></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a><span class="co">#| fold: true</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Environment setup and package installation</span></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>first_time <span class="op">=</span> <span class="va">False</span></span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> first_time:</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First uninstall the conflicting packages</span></span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip uninstall <span class="op">-</span>y <span class="op">-</span>q torch torchvision</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip uninstall <span class="op">-</span>y numpy pandas scipy scikit<span class="op">-</span>learn anndata cell<span class="op">-</span>gears datasets dcor</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">#%pip install -q torchvision==0.16.2 torch==2.1.2</span></span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install <span class="op">-</span>q torch<span class="op">==</span><span class="fl">2.3.0</span> torchvision<span class="op">==</span><span class="fl">0.16.2</span></span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install <span class="op">-</span>q scgpt scanpy gdown</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Then install them in the correct order with specific versions</span></span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install numpy<span class="op">==</span><span class="fl">1.23.5</span></span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install pandas<span class="op">==</span><span class="fl">1.5.3</span>  <span class="co"># This version is compatible with anndata 0.10.9</span></span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install scipy<span class="op">==</span><span class="fl">1.10.1</span>  <span class="co"># This version is &gt;1.8 as required by anndata</span></span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install scikit<span class="op">-</span>learn<span class="op">==</span><span class="fl">1.2.2</span></span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install anndata<span class="op">==</span><span class="fl">0.10.9</span></span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install cell<span class="op">-</span>gears<span class="op">==</span><span class="fl">0.0.2</span></span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install dcor<span class="op">==</span><span class="fl">0.6</span></span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install datasets<span class="op">==</span><span class="fl">2.3.0</span></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First uninstall both packages</span></span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip uninstall <span class="op">-</span>y torch torchtext</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Then install compatible versions</span></span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install torch<span class="op">==</span><span class="fl">2.1.2</span> torchtext<span class="op">==</span><span class="fl">0.16.2</span></span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Package Installation Note**: </span></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We install specific versions of packages to ensure compatibility</span></span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The order of installation matters</span></span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Some packages are uninstalled first to avoid conflicts</span></span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: import-libraries</span></span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a><span class="co">#| fold: true</span></span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Set MPS fallback for unimplemented operations</span></span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'PYTORCH_ENABLE_MPS_FALLBACK'</span>] <span class="op">=</span> <span class="st">'1'</span></span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Monkey-patch os.sched_getaffinity for macOS</span></span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(os, <span class="st">'sched_getaffinity'</span>):</span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sched_getaffinity(pid):</span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">set</span>(<span class="bu">range</span>(multiprocessing.cpu_count()))</span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a>    os.sched_getaffinity <span class="op">=</span> sched_getaffinity</span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scgpt <span class="im">as</span> scg</span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scanpy <span class="im">as</span> sc</span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for MPS availability</span></span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> (</span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a>    torch.device(<span class="st">"mps"</span>)</span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> torch.backends.mps.is_available()</span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> torch.device(<span class="st">"cpu"</span>)</span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using device: </span><span class="sc">{</span>device<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Note: Some operations may fall back to CPU due to MPS limitations"</span>)</span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Library Import Note**:</span></span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We import all necessary libraries for data processing and model inference</span></span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Special handling for macOS MPS (Metal Performance Shaders)</span></span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Warning suppression for cleaner output</span></span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-directories</span></span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the base working directory</span></span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a>WORKDIR <span class="op">=</span> <span class="st">"/Users/haekyungim/Library/CloudStorage/Box-Box/LargeFiles/imlab-data/data-Github/web-data/web-GENE-46100/scgpt"</span></span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Path objects for better path handling</span></span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a>WORKDIR <span class="op">=</span> Path(WORKDIR)</span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a>DATA_DIR <span class="op">=</span> WORKDIR <span class="op">/</span> <span class="st">"data"</span></span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a>MODEL_DIR <span class="op">=</span> WORKDIR <span class="op">/</span> <span class="st">"model"</span> </span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Directory Setup Note**:</span></span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We create a structured directory for data and model files</span></span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Using Path objects for cross-platform compatibility</span></span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a><span class="fu">### Download and Prepare Data</span></span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Data Download Note**:</span></span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We'll download both the model and a sample dataset</span></span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The dataset will be processed to reduce memory usage</span></span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We'll use highly variable genes for better analysis</span></span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: download-model</span></span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">"ignore"</span>, <span class="pp">ResourceWarning</span>)</span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">ImportWarning</span>)</span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Use gdown with the recursive flag to download the folder</span></span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a>folder_id <span class="op">=</span> <span class="st">'1oWh_-ZRdhtoGQ2Fw24HP41FgLoomVo-y'</span></span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if model files already exist</span></span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> (MODEL_DIR <span class="op">/</span> <span class="st">"args.json"</span>).exists():</span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Downloading model checkpoint..."</span>)</span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>gdown <span class="op">--</span>folder {folder_id} <span class="op">-</span>O {MODEL_DIR}</span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Model files already exist in"</span>, MODEL_DIR)</span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Model Download Note**:</span></span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The model is downloaded from Google Drive</span></span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We check if files exist to avoid re-downloading</span></span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The model is about 200MB in size</span></span>
<span id="cb15-224"><a href="#cb15-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: download-data</span></span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> <span class="st">"https://datasets.cellxgene.cziscience.com/f50deffa-43ae-4f12-85ed-33e45040a1fa.h5ad"</span></span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a>source_path <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">"source.h5ad"</span></span>
<span id="cb15-234"><a href="#cb15-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-235"><a href="#cb15-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if file exists before downloading</span></span>
<span id="cb15-236"><a href="#cb15-236" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> source_path.exists():</span>
<span id="cb15-237"><a href="#cb15-237" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Downloading dataset to </span><span class="sc">{</span>source_path<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb15-238"><a href="#cb15-238" aria-hidden="true" tabindex="-1"></a>    urllib.request.urlretrieve(uri, filename<span class="op">=</span><span class="bu">str</span>(source_path))</span>
<span id="cb15-239"><a href="#cb15-239" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-240"><a href="#cb15-240" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Dataset already exists at </span><span class="sc">{</span>source_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-241"><a href="#cb15-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-242"><a href="#cb15-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the data</span></span>
<span id="cb15-243"><a href="#cb15-243" aria-hidden="true" tabindex="-1"></a>adata <span class="op">=</span> sc.read_h5ad(source_path)</span>
<span id="cb15-244"><a href="#cb15-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-245"><a href="#cb15-245" aria-hidden="true" tabindex="-1"></a>batch_key <span class="op">=</span> <span class="st">"sample"</span></span>
<span id="cb15-246"><a href="#cb15-246" aria-hidden="true" tabindex="-1"></a>N_HVG <span class="op">=</span> <span class="dv">3000</span>  <span class="co"># Number of highly variable genes to select</span></span>
<span id="cb15-247"><a href="#cb15-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-248"><a href="#cb15-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Select highly variable genes to reduce memory usage</span></span>
<span id="cb15-249"><a href="#cb15-249" aria-hidden="true" tabindex="-1"></a>sc.pp.highly_variable_genes(adata, n_top_genes<span class="op">=</span>N_HVG, flavor<span class="op">=</span><span class="st">'seurat_v3'</span>)</span>
<span id="cb15-250"><a href="#cb15-250" aria-hidden="true" tabindex="-1"></a>adata_hvg <span class="op">=</span> adata[:, adata.var[<span class="st">'highly_variable'</span>]]</span>
<span id="cb15-251"><a href="#cb15-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-252"><a href="#cb15-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-253"><a href="#cb15-253" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Data Processing Note**:</span></span>
<span id="cb15-254"><a href="#cb15-254" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We download a sample dataset from CZ CELLxGENE</span></span>
<span id="cb15-255"><a href="#cb15-255" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The dataset is reduced to 3000 highly variable genes</span></span>
<span id="cb15-256"><a href="#cb15-256" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - This reduction helps with memory usage and computation speed</span></span>
<span id="cb15-257"><a href="#cb15-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-258"><a href="#cb15-258" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model Inference and Embedding Generation</span></span>
<span id="cb15-259"><a href="#cb15-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-260"><a href="#cb15-260" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Key Concept**: In this section, we'll:</span></span>
<span id="cb15-261"><a href="#cb15-261" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 1. Set up the model for inference</span></span>
<span id="cb15-262"><a href="#cb15-262" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 2. Generate cell embeddings using scGPT</span></span>
<span id="cb15-263"><a href="#cb15-263" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 3. Process these embeddings for downstream analysis</span></span>
<span id="cb15-264"><a href="#cb15-264" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span></span>
<span id="cb15-265"><a href="#cb15-265" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Note**: The embedding generation process might take several minutes depending on your hardware.</span></span>
<span id="cb15-266"><a href="#cb15-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-269"><a href="#cb15-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-270"><a href="#cb15-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-embedding</span></span>
<span id="cb15-271"><a href="#cb15-271" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-272"><a href="#cb15-272" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-273"><a href="#cb15-273" aria-hidden="true" tabindex="-1"></a><span class="co">#| fold: true</span></span>
<span id="cb15-274"><a href="#cb15-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-275"><a href="#cb15-275" aria-hidden="true" tabindex="-1"></a><span class="co"># Monkey patch get_batch_cell_embeddings to force single processor</span></span>
<span id="cb15-276"><a href="#cb15-276" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> types</span>
<span id="cb15-277"><a href="#cb15-277" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scgpt.tasks.cell_emb <span class="im">import</span> get_batch_cell_embeddings <span class="im">as</span> original_get_batch_cell_embeddings</span>
<span id="cb15-278"><a href="#cb15-278" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb15-279"><a href="#cb15-279" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader, SequentialSampler</span>
<span id="cb15-280"><a href="#cb15-280" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scgpt.data_collator <span class="im">import</span> DataCollator</span>
<span id="cb15-281"><a href="#cb15-281" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-282"><a href="#cb15-282" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb15-283"><a href="#cb15-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-284"><a href="#cb15-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Dataset class at module level</span></span>
<span id="cb15-285"><a href="#cb15-285" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CellEmbeddingDataset(Dataset):</span>
<span id="cb15-286"><a href="#cb15-286" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-287"><a href="#cb15-287" aria-hidden="true" tabindex="-1"></a><span class="co">    Custom dataset class for cell embedding generation.</span></span>
<span id="cb15-288"><a href="#cb15-288" aria-hidden="true" tabindex="-1"></a><span class="co">    Processes single-cell data into a format suitable for the scGPT model.</span></span>
<span id="cb15-289"><a href="#cb15-289" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-290"><a href="#cb15-290" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, count_matrix, gene_ids, batch_ids<span class="op">=</span><span class="va">None</span>, vocab<span class="op">=</span><span class="va">None</span>, model_configs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb15-291"><a href="#cb15-291" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.count_matrix <span class="op">=</span> count_matrix</span>
<span id="cb15-292"><a href="#cb15-292" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gene_ids <span class="op">=</span> gene_ids</span>
<span id="cb15-293"><a href="#cb15-293" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_ids <span class="op">=</span> batch_ids</span>
<span id="cb15-294"><a href="#cb15-294" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vocab <span class="op">=</span> vocab</span>
<span id="cb15-295"><a href="#cb15-295" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_configs <span class="op">=</span> model_configs</span>
<span id="cb15-296"><a href="#cb15-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-297"><a href="#cb15-297" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb15-298"><a href="#cb15-298" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.count_matrix)</span>
<span id="cb15-299"><a href="#cb15-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-300"><a href="#cb15-300" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb15-301"><a href="#cb15-301" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process a single cell's data</span></span>
<span id="cb15-302"><a href="#cb15-302" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> <span class="va">self</span>.count_matrix[idx]</span>
<span id="cb15-303"><a href="#cb15-303" aria-hidden="true" tabindex="-1"></a>        nonzero_idx <span class="op">=</span> np.nonzero(row)[<span class="dv">0</span>]</span>
<span id="cb15-304"><a href="#cb15-304" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> row[nonzero_idx]</span>
<span id="cb15-305"><a href="#cb15-305" aria-hidden="true" tabindex="-1"></a>        genes <span class="op">=</span> <span class="va">self</span>.gene_ids[nonzero_idx]</span>
<span id="cb15-306"><a href="#cb15-306" aria-hidden="true" tabindex="-1"></a>        <span class="co"># append &lt;cls&gt; token at the beginning</span></span>
<span id="cb15-307"><a href="#cb15-307" aria-hidden="true" tabindex="-1"></a>        genes <span class="op">=</span> np.insert(genes, <span class="dv">0</span>, <span class="va">self</span>.vocab[<span class="st">"&lt;cls&gt;"</span>])</span>
<span id="cb15-308"><a href="#cb15-308" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> np.insert(values, <span class="dv">0</span>, <span class="va">self</span>.model_configs[<span class="st">"pad_value"</span>])</span>
<span id="cb15-309"><a href="#cb15-309" aria-hidden="true" tabindex="-1"></a>        genes <span class="op">=</span> torch.from_numpy(genes).<span class="bu">long</span>()</span>
<span id="cb15-310"><a href="#cb15-310" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> torch.from_numpy(values).<span class="bu">float</span>()</span>
<span id="cb15-311"><a href="#cb15-311" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> {</span>
<span id="cb15-312"><a href="#cb15-312" aria-hidden="true" tabindex="-1"></a>            <span class="st">"id"</span>: idx,</span>
<span id="cb15-313"><a href="#cb15-313" aria-hidden="true" tabindex="-1"></a>            <span class="st">"genes"</span>: genes,</span>
<span id="cb15-314"><a href="#cb15-314" aria-hidden="true" tabindex="-1"></a>            <span class="st">"expressions"</span>: values,</span>
<span id="cb15-315"><a href="#cb15-315" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb15-316"><a href="#cb15-316" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.batch_ids <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb15-317"><a href="#cb15-317" aria-hidden="true" tabindex="-1"></a>            output[<span class="st">"batch_labels"</span>] <span class="op">=</span> <span class="va">self</span>.batch_ids[idx]</span>
<span id="cb15-318"><a href="#cb15-318" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb15-319"><a href="#cb15-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-320"><a href="#cb15-320" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> patched_get_batch_cell_embeddings(</span>
<span id="cb15-321"><a href="#cb15-321" aria-hidden="true" tabindex="-1"></a>    adata,</span>
<span id="cb15-322"><a href="#cb15-322" aria-hidden="true" tabindex="-1"></a>    cell_embedding_mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">"cls"</span>,</span>
<span id="cb15-323"><a href="#cb15-323" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb15-324"><a href="#cb15-324" aria-hidden="true" tabindex="-1"></a>    vocab<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb15-325"><a href="#cb15-325" aria-hidden="true" tabindex="-1"></a>    max_length<span class="op">=</span><span class="dv">1200</span>,</span>
<span id="cb15-326"><a href="#cb15-326" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb15-327"><a href="#cb15-327" aria-hidden="true" tabindex="-1"></a>    model_configs<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb15-328"><a href="#cb15-328" aria-hidden="true" tabindex="-1"></a>    gene_ids<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb15-329"><a href="#cb15-329" aria-hidden="true" tabindex="-1"></a>    use_batch_labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb15-330"><a href="#cb15-330" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> np.ndarray:</span>
<span id="cb15-331"><a href="#cb15-331" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-332"><a href="#cb15-332" aria-hidden="true" tabindex="-1"></a><span class="co">    Patched version of get_batch_cell_embeddings that uses the module-level Dataset class</span></span>
<span id="cb15-333"><a href="#cb15-333" aria-hidden="true" tabindex="-1"></a><span class="co">    and forces num_workers=0 for better compatibility.</span></span>
<span id="cb15-334"><a href="#cb15-334" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-335"><a href="#cb15-335" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert data to appropriate format</span></span>
<span id="cb15-336"><a href="#cb15-336" aria-hidden="true" tabindex="-1"></a>    count_matrix <span class="op">=</span> adata.X</span>
<span id="cb15-337"><a href="#cb15-337" aria-hidden="true" tabindex="-1"></a>    count_matrix <span class="op">=</span> (</span>
<span id="cb15-338"><a href="#cb15-338" aria-hidden="true" tabindex="-1"></a>        count_matrix <span class="cf">if</span> <span class="bu">isinstance</span>(count_matrix, np.ndarray) <span class="cf">else</span> count_matrix.toarray()</span>
<span id="cb15-339"><a href="#cb15-339" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-340"><a href="#cb15-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-341"><a href="#cb15-341" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get gene vocabulary ids</span></span>
<span id="cb15-342"><a href="#cb15-342" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gene_ids <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb15-343"><a href="#cb15-343" aria-hidden="true" tabindex="-1"></a>        gene_ids <span class="op">=</span> np.array(adata.var[<span class="st">"id_in_vocab"</span>])</span>
<span id="cb15-344"><a href="#cb15-344" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> np.<span class="bu">all</span>(gene_ids <span class="op">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb15-345"><a href="#cb15-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-346"><a href="#cb15-346" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_batch_labels:</span>
<span id="cb15-347"><a href="#cb15-347" aria-hidden="true" tabindex="-1"></a>        batch_ids <span class="op">=</span> np.array(adata.obs[<span class="st">"batch_id"</span>].tolist())</span>
<span id="cb15-348"><a href="#cb15-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-349"><a href="#cb15-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cell_embedding_mode <span class="op">==</span> <span class="st">"cls"</span>:</span>
<span id="cb15-350"><a href="#cb15-350" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set up dataset and data loader</span></span>
<span id="cb15-351"><a href="#cb15-351" aria-hidden="true" tabindex="-1"></a>        dataset <span class="op">=</span> CellEmbeddingDataset(</span>
<span id="cb15-352"><a href="#cb15-352" aria-hidden="true" tabindex="-1"></a>            count_matrix, </span>
<span id="cb15-353"><a href="#cb15-353" aria-hidden="true" tabindex="-1"></a>            gene_ids, </span>
<span id="cb15-354"><a href="#cb15-354" aria-hidden="true" tabindex="-1"></a>            batch_ids <span class="cf">if</span> use_batch_labels <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb15-355"><a href="#cb15-355" aria-hidden="true" tabindex="-1"></a>            vocab<span class="op">=</span>vocab,</span>
<span id="cb15-356"><a href="#cb15-356" aria-hidden="true" tabindex="-1"></a>            model_configs<span class="op">=</span>model_configs</span>
<span id="cb15-357"><a href="#cb15-357" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-358"><a href="#cb15-358" aria-hidden="true" tabindex="-1"></a>        collator <span class="op">=</span> DataCollator(</span>
<span id="cb15-359"><a href="#cb15-359" aria-hidden="true" tabindex="-1"></a>            do_padding<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-360"><a href="#cb15-360" aria-hidden="true" tabindex="-1"></a>            pad_token_id<span class="op">=</span>vocab[model_configs[<span class="st">"pad_token"</span>]],</span>
<span id="cb15-361"><a href="#cb15-361" aria-hidden="true" tabindex="-1"></a>            pad_value<span class="op">=</span>model_configs[<span class="st">"pad_value"</span>],</span>
<span id="cb15-362"><a href="#cb15-362" aria-hidden="true" tabindex="-1"></a>            do_mlm<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb15-363"><a href="#cb15-363" aria-hidden="true" tabindex="-1"></a>            do_binning<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-364"><a href="#cb15-364" aria-hidden="true" tabindex="-1"></a>            max_length<span class="op">=</span>max_length,</span>
<span id="cb15-365"><a href="#cb15-365" aria-hidden="true" tabindex="-1"></a>            sampling<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-366"><a href="#cb15-366" aria-hidden="true" tabindex="-1"></a>            keep_first_n_tokens<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb15-367"><a href="#cb15-367" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-368"><a href="#cb15-368" aria-hidden="true" tabindex="-1"></a>        data_loader <span class="op">=</span> DataLoader(</span>
<span id="cb15-369"><a href="#cb15-369" aria-hidden="true" tabindex="-1"></a>            dataset,</span>
<span id="cb15-370"><a href="#cb15-370" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size,</span>
<span id="cb15-371"><a href="#cb15-371" aria-hidden="true" tabindex="-1"></a>            sampler<span class="op">=</span>SequentialSampler(dataset),</span>
<span id="cb15-372"><a href="#cb15-372" aria-hidden="true" tabindex="-1"></a>            collate_fn<span class="op">=</span>collator,</span>
<span id="cb15-373"><a href="#cb15-373" aria-hidden="true" tabindex="-1"></a>            drop_last<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb15-374"><a href="#cb15-374" aria-hidden="true" tabindex="-1"></a>            num_workers<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Force single worker for compatibility</span></span>
<span id="cb15-375"><a href="#cb15-375" aria-hidden="true" tabindex="-1"></a>            pin_memory<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-376"><a href="#cb15-376" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-377"><a href="#cb15-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-378"><a href="#cb15-378" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate embeddings</span></span>
<span id="cb15-379"><a href="#cb15-379" aria-hidden="true" tabindex="-1"></a>        cell_embeddings <span class="op">=</span> np.zeros(</span>
<span id="cb15-380"><a href="#cb15-380" aria-hidden="true" tabindex="-1"></a>            (<span class="bu">len</span>(dataset), model_configs[<span class="st">"embsize"</span>]), dtype<span class="op">=</span>np.float32</span>
<span id="cb15-381"><a href="#cb15-381" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-382"><a href="#cb15-382" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb15-383"><a href="#cb15-383" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb15-384"><a href="#cb15-384" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> data_dict <span class="kw">in</span> tqdm(data_loader, desc<span class="op">=</span><span class="st">"Embedding cells"</span>):</span>
<span id="cb15-385"><a href="#cb15-385" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Process each batch of cells</span></span>
<span id="cb15-386"><a href="#cb15-386" aria-hidden="true" tabindex="-1"></a>                input_gene_ids <span class="op">=</span> data_dict[<span class="st">"gene"</span>].to(device)</span>
<span id="cb15-387"><a href="#cb15-387" aria-hidden="true" tabindex="-1"></a>                src_key_padding_mask <span class="op">=</span> input_gene_ids.eq(</span>
<span id="cb15-388"><a href="#cb15-388" aria-hidden="true" tabindex="-1"></a>                    vocab[model_configs[<span class="st">"pad_token"</span>]]</span>
<span id="cb15-389"><a href="#cb15-389" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb15-390"><a href="#cb15-390" aria-hidden="true" tabindex="-1"></a>                embeddings <span class="op">=</span> model._encode(</span>
<span id="cb15-391"><a href="#cb15-391" aria-hidden="true" tabindex="-1"></a>                    input_gene_ids,</span>
<span id="cb15-392"><a href="#cb15-392" aria-hidden="true" tabindex="-1"></a>                    data_dict[<span class="st">"expr"</span>].to(device),</span>
<span id="cb15-393"><a href="#cb15-393" aria-hidden="true" tabindex="-1"></a>                    src_key_padding_mask<span class="op">=</span>src_key_padding_mask,</span>
<span id="cb15-394"><a href="#cb15-394" aria-hidden="true" tabindex="-1"></a>                    batch_labels<span class="op">=</span>data_dict[<span class="st">"batch_labels"</span>].to(device)</span>
<span id="cb15-395"><a href="#cb15-395" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> use_batch_labels</span>
<span id="cb15-396"><a href="#cb15-396" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb15-397"><a href="#cb15-397" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb15-398"><a href="#cb15-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-399"><a href="#cb15-399" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Extract CLS token embeddings and normalize</span></span>
<span id="cb15-400"><a href="#cb15-400" aria-hidden="true" tabindex="-1"></a>                embeddings <span class="op">=</span> embeddings[:, <span class="dv">0</span>, :]  <span class="co"># get the &lt;cls&gt; position embedding</span></span>
<span id="cb15-401"><a href="#cb15-401" aria-hidden="true" tabindex="-1"></a>                embeddings <span class="op">=</span> embeddings.cpu().numpy()</span>
<span id="cb15-402"><a href="#cb15-402" aria-hidden="true" tabindex="-1"></a>                cell_embeddings[count : count <span class="op">+</span> <span class="bu">len</span>(embeddings)] <span class="op">=</span> embeddings</span>
<span id="cb15-403"><a href="#cb15-403" aria-hidden="true" tabindex="-1"></a>                count <span class="op">+=</span> <span class="bu">len</span>(embeddings)</span>
<span id="cb15-404"><a href="#cb15-404" aria-hidden="true" tabindex="-1"></a>        cell_embeddings <span class="op">=</span> cell_embeddings <span class="op">/</span> np.linalg.norm(</span>
<span id="cb15-405"><a href="#cb15-405" aria-hidden="true" tabindex="-1"></a>            cell_embeddings, axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span></span>
<span id="cb15-406"><a href="#cb15-406" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-407"><a href="#cb15-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb15-408"><a href="#cb15-408" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown cell embedding mode: </span><span class="sc">{</span>cell_embedding_mode<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-409"><a href="#cb15-409" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cell_embeddings</span>
<span id="cb15-410"><a href="#cb15-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-411"><a href="#cb15-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace the original function with our patched version</span></span>
<span id="cb15-412"><a href="#cb15-412" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scgpt.tasks.cell_emb</span>
<span id="cb15-413"><a href="#cb15-413" aria-hidden="true" tabindex="-1"></a>scgpt.tasks.cell_emb.get_batch_cell_embeddings <span class="op">=</span> patched_get_batch_cell_embeddings</span>
<span id="cb15-414"><a href="#cb15-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-415"><a href="#cb15-415" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'PYTHONWARNINGS'</span>] <span class="op">=</span> <span class="st">'ignore'</span></span>
<span id="cb15-416"><a href="#cb15-416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-417"><a href="#cb15-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-418"><a href="#cb15-418" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Technical Note**: The code above:</span></span>
<span id="cb15-419"><a href="#cb15-419" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Creates a custom dataset class for processing single-cell data</span></span>
<span id="cb15-420"><a href="#cb15-420" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Implements a patched version of the embedding function for better compatibility</span></span>
<span id="cb15-421"><a href="#cb15-421" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Handles data batching and normalization</span></span>
<span id="cb15-422"><a href="#cb15-422" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Uses the CLS token for cell representation</span></span>
<span id="cb15-423"><a href="#cb15-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-426"><a href="#cb15-426" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-427"><a href="#cb15-427" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate-embeddings</span></span>
<span id="cb15-428"><a href="#cb15-428" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-429"><a href="#cb15-429" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-430"><a href="#cb15-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-431"><a href="#cb15-431" aria-hidden="true" tabindex="-1"></a>model_dir <span class="op">=</span> MODEL_DIR</span>
<span id="cb15-432"><a href="#cb15-432" aria-hidden="true" tabindex="-1"></a>gene_col <span class="op">=</span> <span class="st">"feature_name"</span></span>
<span id="cb15-433"><a href="#cb15-433" aria-hidden="true" tabindex="-1"></a>cell_type_key <span class="op">=</span> <span class="st">"cell_type"</span></span>
<span id="cb15-434"><a href="#cb15-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-435"><a href="#cb15-435" aria-hidden="true" tabindex="-1"></a>embedding_file <span class="op">=</span> DATA_DIR <span class="op">/</span> <span class="st">"ref_embed_adata.h5ad"</span></span>
<span id="cb15-436"><a href="#cb15-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-437"><a href="#cb15-437" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> embedding_file.exists():</span>
<span id="cb15-438"><a href="#cb15-438" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Loading existing embeddings from </span><span class="sc">{</span>embedding_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-439"><a href="#cb15-439" aria-hidden="true" tabindex="-1"></a>    ref_embed_adata <span class="op">=</span> sc.read_h5ad(<span class="bu">str</span>(embedding_file))</span>
<span id="cb15-440"><a href="#cb15-440" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-441"><a href="#cb15-441" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Computing new embeddings..."</span>)</span>
<span id="cb15-442"><a href="#cb15-442" aria-hidden="true" tabindex="-1"></a>    ref_embed_adata <span class="op">=</span> scg.tasks.embed_data(</span>
<span id="cb15-443"><a href="#cb15-443" aria-hidden="true" tabindex="-1"></a>        adata_hvg,</span>
<span id="cb15-444"><a href="#cb15-444" aria-hidden="true" tabindex="-1"></a>        model_dir,</span>
<span id="cb15-445"><a href="#cb15-445" aria-hidden="true" tabindex="-1"></a>        gene_col<span class="op">=</span>gene_col,</span>
<span id="cb15-446"><a href="#cb15-446" aria-hidden="true" tabindex="-1"></a>        obs_to_save<span class="op">=</span>cell_type_key,</span>
<span id="cb15-447"><a href="#cb15-447" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb15-448"><a href="#cb15-448" aria-hidden="true" tabindex="-1"></a>        return_new_adata<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-449"><a href="#cb15-449" aria-hidden="true" tabindex="-1"></a>        device<span class="op">=</span>device,</span>
<span id="cb15-450"><a href="#cb15-450" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-451"><a href="#cb15-451" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saving embeddings to </span><span class="sc">{</span>embedding_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-452"><a href="#cb15-452" aria-hidden="true" tabindex="-1"></a>    ref_embed_adata.write(<span class="bu">str</span>(embedding_file))</span>
<span id="cb15-453"><a href="#cb15-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-454"><a href="#cb15-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-455"><a href="#cb15-455" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Embedding Generation Note**:</span></span>
<span id="cb15-456"><a href="#cb15-456" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We first check if embeddings already exist to avoid recomputing</span></span>
<span id="cb15-457"><a href="#cb15-457" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The embedding process generates a 512-dimensional representation for each cell</span></span>
<span id="cb15-458"><a href="#cb15-458" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Results are saved for future use</span></span>
<span id="cb15-459"><a href="#cb15-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-462"><a href="#cb15-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-463"><a href="#cb15-463" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-embeddings</span></span>
<span id="cb15-464"><a href="#cb15-464" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-465"><a href="#cb15-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-466"><a href="#cb15-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-467"><a href="#cb15-467" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the shape of our embeddings</span></span>
<span id="cb15-468"><a href="#cb15-468" aria-hidden="true" tabindex="-1"></a>ref_embed_adata.X.shape</span>
<span id="cb15-469"><a href="#cb15-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-470"><a href="#cb15-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-471"><a href="#cb15-471" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Shape Explanation**:</span></span>
<span id="cb15-472"><a href="#cb15-472" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The output shows (number of cells × 512)</span></span>
<span id="cb15-473"><a href="#cb15-473" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - 512 is the embedding dimension of scGPT</span></span>
<span id="cb15-474"><a href="#cb15-474" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Each cell is represented by a 512-dimensional vector</span></span>
<span id="cb15-475"><a href="#cb15-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-476"><a href="#cb15-476" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dimensionality Reduction and Visualization</span></span>
<span id="cb15-477"><a href="#cb15-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-478"><a href="#cb15-478" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Key Concept**: In this section, we'll:</span></span>
<span id="cb15-479"><a href="#cb15-479" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 1. Compute cell-cell similarities using the embeddings</span></span>
<span id="cb15-480"><a href="#cb15-480" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 2. Generate a UMAP visualization</span></span>
<span id="cb15-481"><a href="#cb15-481" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 3. Compare different cell type annotations</span></span>
<span id="cb15-482"><a href="#cb15-482" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span></span>
<span id="cb15-483"><a href="#cb15-483" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Note**: UMAP helps us visualize high-dimensional data in 2D while preserving important relationships.</span></span>
<span id="cb15-484"><a href="#cb15-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-487"><a href="#cb15-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-488"><a href="#cb15-488" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compute-neighbors</span></span>
<span id="cb15-489"><a href="#cb15-489" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-490"><a href="#cb15-490" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-491"><a href="#cb15-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-492"><a href="#cb15-492" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute cell-cell similarities</span></span>
<span id="cb15-493"><a href="#cb15-493" aria-hidden="true" tabindex="-1"></a>sc.pp.neighbors(ref_embed_adata, use_rep<span class="op">=</span><span class="st">"X"</span>)</span>
<span id="cb15-494"><a href="#cb15-494" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate UMAP coordinates</span></span>
<span id="cb15-495"><a href="#cb15-495" aria-hidden="true" tabindex="-1"></a>sc.tl.umap(ref_embed_adata)</span>
<span id="cb15-496"><a href="#cb15-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-497"><a href="#cb15-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-498"><a href="#cb15-498" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Neighborhood Graph Note**:</span></span>
<span id="cb15-499"><a href="#cb15-499" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We compute a neighborhood graph based on the embeddings</span></span>
<span id="cb15-500"><a href="#cb15-500" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - This graph is used to generate the UMAP visualization</span></span>
<span id="cb15-501"><a href="#cb15-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-504"><a href="#cb15-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-505"><a href="#cb15-505" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: transfer-embeddings</span></span>
<span id="cb15-506"><a href="#cb15-506" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-507"><a href="#cb15-507" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-508"><a href="#cb15-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-509"><a href="#cb15-509" aria-hidden="true" tabindex="-1"></a><span class="co"># Transfer embeddings and UMAP to original adata object</span></span>
<span id="cb15-510"><a href="#cb15-510" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">"X_scgpt"</span>] <span class="op">=</span> ref_embed_adata.X</span>
<span id="cb15-511"><a href="#cb15-511" aria-hidden="true" tabindex="-1"></a>adata.obsm[<span class="st">"X_umap"</span>] <span class="op">=</span> ref_embed_adata.obsm[<span class="st">"X_umap"</span>]</span>
<span id="cb15-512"><a href="#cb15-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-513"><a href="#cb15-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-514"><a href="#cb15-514" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Data Transfer Note**:</span></span>
<span id="cb15-515"><a href="#cb15-515" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We transfer the embeddings and UMAP coordinates to our original dataset</span></span>
<span id="cb15-516"><a href="#cb15-516" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - This allows us to use the original annotations with our new embeddings</span></span>
<span id="cb15-517"><a href="#cb15-517" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The embeddings are stored in </span><span class="in">`.obsm`</span><span class="at"> for easy access</span></span>
<span id="cb15-518"><a href="#cb15-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-521"><a href="#cb15-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-522"><a href="#cb15-522" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prepare-gene-names</span></span>
<span id="cb15-523"><a href="#cb15-523" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-524"><a href="#cb15-524" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-525"><a href="#cb15-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-526"><a href="#cb15-526" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the current index ('ensembl_id') as a new column</span></span>
<span id="cb15-527"><a href="#cb15-527" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'ensembl_id'</span>] <span class="op">=</span> adata.var.index</span>
<span id="cb15-528"><a href="#cb15-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-529"><a href="#cb15-529" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the new index to the 'feature_name' column</span></span>
<span id="cb15-530"><a href="#cb15-530" aria-hidden="true" tabindex="-1"></a>adata.var.set_index(<span class="st">'feature_name'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-531"><a href="#cb15-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-532"><a href="#cb15-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a copy of the gene symbols back to the var dataframe</span></span>
<span id="cb15-533"><a href="#cb15-533" aria-hidden="true" tabindex="-1"></a>adata.var[<span class="st">'gene_symbol'</span>] <span class="op">=</span> adata.var.index</span>
<span id="cb15-534"><a href="#cb15-534" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-535"><a href="#cb15-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-536"><a href="#cb15-536" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Gene Name Processing Note**:</span></span>
<span id="cb15-537"><a href="#cb15-537" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We reorganize the gene annotations for easier access</span></span>
<span id="cb15-538"><a href="#cb15-538" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - This allows us to use gene symbols in visualizations</span></span>
<span id="cb15-539"><a href="#cb15-539" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Both Ensembl IDs and gene symbols are preserved</span></span>
<span id="cb15-540"><a href="#cb15-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-541"><a href="#cb15-541" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualization</span></span>
<span id="cb15-542"><a href="#cb15-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-543"><a href="#cb15-543" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Key Concept**: In this section, we'll:</span></span>
<span id="cb15-544"><a href="#cb15-544" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 1. Visualize the UMAP colored by different cell type annotations</span></span>
<span id="cb15-545"><a href="#cb15-545" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 2. Examine marker gene expression</span></span>
<span id="cb15-546"><a href="#cb15-546" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 3. Compare different annotation schemes</span></span>
<span id="cb15-547"><a href="#cb15-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-550"><a href="#cb15-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-551"><a href="#cb15-551" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-umap-celltypes</span></span>
<span id="cb15-552"><a href="#cb15-552" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-553"><a href="#cb15-553" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-554"><a href="#cb15-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-555"><a href="#cb15-555" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb15-556"><a href="#cb15-556" aria-hidden="true" tabindex="-1"></a>    warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb15-557"><a href="#cb15-557" aria-hidden="true" tabindex="-1"></a>    sc.pl.umap(adata, color<span class="op">=</span>[<span class="st">"cell_type"</span>, <span class="st">"annotation_res0.34_new2"</span>], wspace <span class="op">=</span> <span class="fl">0.6</span>)</span>
<span id="cb15-558"><a href="#cb15-558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-559"><a href="#cb15-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-560"><a href="#cb15-560" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **UMAP Visualization Note**:</span></span>
<span id="cb15-561"><a href="#cb15-561" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The plot shows cells colored by two different annotation schemes</span></span>
<span id="cb15-562"><a href="#cb15-562" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - This helps us compare different cell type classifications</span></span>
<span id="cb15-563"><a href="#cb15-563" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - The spatial organization reflects cell type relationships</span></span>
<span id="cb15-564"><a href="#cb15-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-567"><a href="#cb15-567" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb15-568"><a href="#cb15-568" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-umap-markers</span></span>
<span id="cb15-569"><a href="#cb15-569" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb15-570"><a href="#cb15-570" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: true</span></span>
<span id="cb15-571"><a href="#cb15-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-572"><a href="#cb15-572" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize marker genes for different cell types</span></span>
<span id="cb15-573"><a href="#cb15-573" aria-hidden="true" tabindex="-1"></a>sc.pl.umap(adata, </span>
<span id="cb15-574"><a href="#cb15-574" aria-hidden="true" tabindex="-1"></a>           color<span class="op">=</span>[<span class="st">'cell_type'</span>, <span class="st">'MKI67'</span>, <span class="st">'LYZ'</span>, <span class="st">'RBP2'</span>, <span class="st">'MUC2'</span>, <span class="st">'CHGA'</span>, <span class="st">'TAGLN'</span>, <span class="st">'ELAVL3'</span>], </span>
<span id="cb15-575"><a href="#cb15-575" aria-hidden="true" tabindex="-1"></a>           frameon<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb15-576"><a href="#cb15-576" aria-hidden="true" tabindex="-1"></a>           use_raw<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb15-577"><a href="#cb15-577" aria-hidden="true" tabindex="-1"></a>           legend_fontsize<span class="op">=</span><span class="st">"xx-small"</span>, </span>
<span id="cb15-578"><a href="#cb15-578" aria-hidden="true" tabindex="-1"></a>           legend_loc<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb15-579"><a href="#cb15-579" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb15-580"><a href="#cb15-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-581"><a href="#cb15-581" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Marker Gene Note**:</span></span>
<span id="cb15-582"><a href="#cb15-582" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - We visualize expression of key marker genes</span></span>
<span id="cb15-583"><a href="#cb15-583" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - These genes help identify different cell types:</span></span>
<span id="cb15-584"><a href="#cb15-584" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;   - MKI67: Proliferating cells</span></span>
<span id="cb15-585"><a href="#cb15-585" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;   - LYZ: Myeloid cells</span></span>
<span id="cb15-586"><a href="#cb15-586" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;   - RBP2: Enterocytes</span></span>
<span id="cb15-587"><a href="#cb15-587" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;   - MUC2: Goblet cells</span></span>
<span id="cb15-588"><a href="#cb15-588" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;   - CHGA: Enteroendocrine cells</span></span>
<span id="cb15-589"><a href="#cb15-589" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;   - TAGLN: Smooth muscle cells</span></span>
<span id="cb15-590"><a href="#cb15-590" aria-hidden="true" tabindex="-1"></a><span class="at">&gt;   - ELAVL3: Neurons</span></span>
<span id="cb15-591"><a href="#cb15-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-592"><a href="#cb15-592" aria-hidden="true" tabindex="-1"></a><span class="fu">### References</span></span>
<span id="cb15-593"><a href="#cb15-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-594"><a href="#cb15-594" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Key Papers**:</span></span>
<span id="cb15-595"><a href="#cb15-595" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 1. scGPT paper: Foundation model for single-cell multi-omics</span></span>
<span id="cb15-596"><a href="#cb15-596" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 2. Dataset paper: iPSC-derived small intestine-on-chip</span></span>
<span id="cb15-597"><a href="#cb15-597" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 3. CZ CELLxGENE platform paper</span></span>
<span id="cb15-598"><a href="#cb15-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-599"><a href="#cb15-599" aria-hidden="true" tabindex="-1"></a>Please refer to the following papers for more information:</span>
<span id="cb15-600"><a href="#cb15-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-601"><a href="#cb15-601" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**scGPT: Toward building a foundation model for single-cell multi-omics using generative AI**</span>
<span id="cb15-602"><a href="#cb15-602" aria-hidden="true" tabindex="-1"></a>Cui, H., Wang, C., Maan, H. et al. Nature Methods 21, 1470–1480 (2024) https://doi.org/10.1038/s41592-024-02201-0</span>
<span id="cb15-603"><a href="#cb15-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-604"><a href="#cb15-604" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**The dataset used in this tutorial**</span>
<span id="cb15-605"><a href="#cb15-605" aria-hidden="true" tabindex="-1"></a>Moerkens, R., et al. Cell Reports, 43(7) (2024) https://doi.org/10.1016/j.celrep.2024.114247</span>
<span id="cb15-606"><a href="#cb15-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-607"><a href="#cb15-607" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**CZ CELLxGENE Discover and Census**</span>
<span id="cb15-608"><a href="#cb15-608" aria-hidden="true" tabindex="-1"></a>CZI Single-Cell Biology, et al. bioRxiv 2023.10.30 doi: https://doi.org/10.1101/2023.10.30.563174</span>
<span id="cb15-609"><a href="#cb15-609" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>